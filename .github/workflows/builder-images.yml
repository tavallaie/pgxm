name: PGXM builder images

on:
  push:
    branches:
      - "main"
    paths:
      - "images/**"
      - ".github/workflows/builder-images.yml"
  pull_request:
    branches:
      - "main"
    paths:
      - "images/**"
      - ".github/workflows/builder-images.yml"

permissions:
  packages: write
  contents: read

jobs:
  build_and_push_c_builders:
    name: 🧱 ${{ matrix.arch }} C on 🐘 ${{ matrix.pg_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: ["arm64", "amd64"]
        pg_version: ["14", "15", "16", "17"]
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up QEMU (for ARM64)
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: images/c-builder
          push: true
          build-args: PG_VERSION=${{ matrix.pg_version }}
          platforms: linux/${{ matrix.arch }}
          tags: ghcr.io/${{ github.repository_owner }}/pgxm/c-builder:pg${{ matrix.pg_version }}-${{ matrix.arch }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create_and_push_c_manifests:
    needs: build_and_push_c_builders
    if: github.ref_name == 'main'
    name: 🗂️ C on 🐘 ${{ matrix.pg_version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg_version: ["14", "15", "16", "17"]
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Create and push manifest
        run: |
          set -xe
          docker buildx imagetools create \
            -t ghcr.io/${{ github.repository_owner }}/pgxm/c-builder:pg${{ matrix.pg_version }} \
            ghcr.io/${{ github.repository_owner }}/pgxm/c-builder:pg${{ matrix.pg_version }}-amd64 \
            ghcr.io/${{ github.repository_owner }}/pgxm/c-builder:pg${{ matrix.pg_version }}-arm64

  build_and_push_pgrx_builders:
    needs: build_and_push_c_builders
    name: 🦀 ${{ matrix.arch }} pgrx on 🐘 ${{ matrix.pg_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: ["arm64", "amd64"]
        pg_version: ["14", "15", "16", "17"]
        pgrx_versions:
          - ["0.11.0", "0.11.1", "0.11.2", "0.11.3", "0.11.4"]
          - ["0.12.0", "0.12.1", "0.12.2", "0.12.3", "0.12.4", "0.12.5", "0.12.6", "0.12.7", "0.12.8", "0.12.9"]
          - ["0.13.0", "0.13.1", "0.14.0", "0.14.1"]
        exclude:
          - pg_version: "17"
            pgrx_versions: ["0.11.0", "0.11.1", "0.11.2", "0.11.3", "0.11.4"]
          - pg_version: "17"
            pgrx_versions: ["0.12.0", "0.12.1", "0.12.2", "0.12.3", "0.12.4"]
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up QEMU (for ARM64)
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Pull c-builder image
        run: docker pull ghcr.io/${{ github.repository_owner }}/pgxm/c-builder:pg${{ matrix.pg_version }}-${{ matrix.arch }}
      - name: Build and push images for pgrx versions
        run: |
          set -xe
          for version in ${{ join(matrix.pgrx_versions, ' ') }}; do
            docker buildx build \
              --platform linux/${{ matrix.arch }} \
              --build-arg PG_VERSION=${{ matrix.pg_version }} \
              --build-arg PGRX_VERSION=$version \
              -t ghcr.io/${{ github.repository_owner }}/pgxm/pgrx-builder:pg${{ matrix.pg_version }}-pgrx$version-${{ matrix.arch }} \
              --push \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              images/pgrx-builder || echo "Build failed for pgrx $version, continuing..."
          done

  create_and_push_pgrx_manifests:
    name: 🗂️ pgrx on 🐘 ${{ matrix.pg_version }}
    if: github.ref_name == 'main'
    needs: build_and_push_pgrx_builders
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        pg_version: ["14", "15", "16", "17"]
        pgrx_versions:
          - ["0.11.0", "0.11.1", "0.11.2", "0.11.3", "0.11.4"]
          - ["0.12.0", "0.12.1", "0.12.2", "0.12.3", "0.12.4", "0.12.5", "0.12.6", "0.12.7", "0.12.8", "0.12.9"]
          - ["0.13.0", "0.13.1", "0.14.0", "0.14.1"]
        exclude:
          - pg_version: "17"
            pgrx_versions: ["0.11.0", "0.11.1", "0.11.2", "0.11.3", "0.11.4"]
          - pg_version: "17"
            pgrx_versions: ["0.12.0", "0.12.1", "0.12.2", "0.12.3", "0.12.4"]
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Create and push manifests
        run: |
          set -xe
          for version in ${{ join(matrix.pgrx_versions, ' ') }}; do
            if docker manifest inspect ghcr.io/${{ github.repository_owner }}/pgxm/pgrx-builder:pg${{ matrix.pg_version }}-pgrx$version-amd64 >/dev/null 2>&1 && \
               docker manifest inspect ghcr.io/${{ github.repository_owner }}/pgxm/pgrx-builder:pg${{ matrix.pg_version }}-pgrx$version-arm64 >/dev/null 2>&1; then
              docker buildx imagetools create \
                -t ghcr.io/${{ github.repository_owner }}/pgxm/pgrx-builder:pg${{ matrix.pg_version }}-pgrx$version \
                ghcr.io/${{ github.repository_owner }}/pgxm/pgrx-builder:pg${{ matrix.pg_version }}-pgrx$version-amd64 \
                ghcr.io/${{ github.repository_owner }}/pgxm/pgrx-builder:pg${{ matrix.pg_version }}-pgrx$version-arm64
            else
              echo "Skipping manifest for pg${{ matrix.pg_version }}-pgrx$version: one or both images missing"
            fi
          done